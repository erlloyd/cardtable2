# Milestone 0.5 ‚Äî Tool Upgrades to Latest Stable

## Status: üöß IN PROGRESS

## Overview
Upgrade all development tools, frameworks, and libraries to their latest stable versions before beginning feature development in M1. This ensures we're building on the most current, secure, and performant foundation.

## Prerequisites
- Milestone 0 completed (monorepo and tooling setup)

## Current vs Target Versions

### Critical Upgrades (Breaking Changes Expected)
| Package | Current | Target | Impact |
|---------|---------|--------|--------|
| React | 18.3.1 | 19.2.0 | Major - requires code changes |
| React DOM | 18.3.1 | 19.2.0 | Major - follows React |
| Vite | 5.4.11 | 7.2.2 | Major - requires Node 20.19+/22.12+ |
| Vitest | 2.1.6 | 3.2.0 | Major - Vite 6+ support |
| Express | 4.21.2 | 5.1.0 | Major - breaking API changes |
| y-websocket | 2.0.4 | 3.0.0 | Major - API changes likely |

### Standard Upgrades (Minor/Patch)
| Package | Current | Target | Impact |
|---------|---------|--------|--------|
| ESLint | 9.15.0 | 9.39.1 | Patch - bug fixes |
| Prettier | 3.4.1 | 3.6.2 | Minor - formatting improvements |
| Yjs | 13.6.20 | 13.6.27 | Patch - bug fixes |
| React Router | 6.28.0 | Latest 6.x | Minor - new features |
| @typescript-eslint/* | 8.15.0 | Latest 8.x | Patch - bug fixes |

## Current Progress Summary

### Completed ‚úÖ
- **M0.5-T1**: Node.js upgraded to v24.11.0, all package.json engines updated
- **M0.5-T2**: Vite upgraded to 7.2.2, Vitest upgraded to 4.0.8
- **M0.5-T4**: ESLint upgraded to 9.36.0, Prettier upgraded to 3.6.2, TypeScript at 5.9.2

### Partially Complete ‚ö†Ô∏è
- **M0.5-T6**: Yjs upgraded to 13.6.27 ‚úÖ, but y-websocket still at 2.1.0 (target 3.0.0)
- React Router upgraded to 6.30.1 (was 6.28.0)

### Remaining üî¥
- **M0.5-T3**: React 18.3.1 ‚Üí 19.2.0 upgrade pending
- **M0.5-T5**: Express 4.21.2 ‚Üí 5.1.0 upgrade pending
- **M0.5-T6**: y-websocket 2.1.0 ‚Üí 3.0.0 upgrade pending
- **M0.5-T7**: Final validation and documentation

## Tasks

### M0.5-T1: Update Node.js Requirements ‚úÖ COMPLETED
**Objective:** Ensure all environments meet Vite 7's Node.js requirements.

**Dependencies:** None

**Spec:**
- Update `.github/workflows/ci.yml` Node matrix to 20.19+ and 22.12+
- Update `package.json` engines field
- Update developer documentation
- Verify local Node.js version

**Deliverables:**
- Updated CI workflow with correct Node versions
- Updated package.json engines constraints
- Verification that CI passes with new Node versions

**Test Plan:**
- CI runs successfully on both Node 20.19+ and 22.12+
- Verify `pnpm run validate` passes locally
- Check Node version detection in CI logs

### M0.5-T2: Upgrade Vite and Vitest ‚úÖ COMPLETED
**Objective:** Upgrade Vite to v7 and Vitest to v3 with their breaking changes.

**Dependencies:** M0.5-T1

**Actual Result:** Vite upgraded to 7.2.2, Vitest upgraded to 4.0.8 (even newer than target 3.2.0!)

**Spec:**
- Upgrade Vite 5.4.11 ‚Üí 7.2.2
- Upgrade Vitest 2.1.6 ‚Üí 3.2.0
- Update vite.config.ts for new browser target
- Review and apply migration guide changes
- Update all Vite plugins to compatible versions

**Known Breaking Changes:**
- Vite 7 is ESM-only
- New default browser target: 'baseline-widely-available'
- Chrome 87‚Üí107, Edge 88‚Üí107, Firefox 78‚Üí104, Safari 14.0‚Üí16.0
- Vitest 3 requires Vite 6+ (but works with Vite 7)

**Deliverables:**
- Updated Vite and Vitest in app/package.json
- Updated vite.config.ts with new settings
- All tests passing with new versions
- Build succeeds with new versions

**Test Plan:**
- `pnpm run dev` starts successfully
- `pnpm run build` completes without errors
- `pnpm run test` passes all tests
- Hot module reload works correctly
- Verify browser target changes don't break compatibility

**Migration Docs:**
- [Vite 7 Migration Guide](https://vite.dev/guide/migration)
- [Vite 6 Migration Guide](https://vite.dev/blog/announcing-vite6) (also review)
- [Vitest 3 Announcement](https://vitest.dev/blog/vitest-3)

### M0.5-T3: Upgrade React to v19 üî¥ TODO
**Objective:** Upgrade React and React DOM to v19 with compatibility updates.

**Dependencies:** M0.5-T2 (for testing infrastructure)

**Current Status:** React still at 18.3.1 - needs upgrade to 19.2.0

**Spec:**
- Upgrade react 18.3.1 ‚Üí 19.2.0
- Upgrade react-dom 18.3.1 ‚Üí 19.2.0
- Upgrade @types/react and @types/react-dom
- Update React Router to latest 6.x (if needed for React 19 compat)
- Review and apply React 19 migration changes
- Update test utilities (@testing-library/react)

**Known Breaking Changes:**
- Ref cleanup function in useEffect
- New JSX transform may affect some code
- Changes to hydration behavior
- Stricter checks on certain patterns

**Deliverables:**
- Updated React packages in app/package.json
- Code changes for React 19 compatibility
- All tests passing with React 19
- Type checking passes with new @types packages

**Test Plan:**
- All existing tests pass
- App renders without console warnings/errors
- Type checking succeeds: `pnpm run typecheck`
- No deprecated API warnings in console

**Migration Docs:**
- [React 19 Upgrade Guide](https://react.dev/blog/2025/10/01/react-19-2)
- React Router compatibility notes

### M0.5-T4: Upgrade ESLint and Prettier ‚úÖ COMPLETED
**Objective:** Update linting and formatting tools to latest versions.

**Dependencies:** None (can run in parallel with other tasks)

**Actual Result:** ESLint 9.36.0, Prettier 3.6.2, TypeScript 5.9.2

**Spec:**
- Upgrade eslint 9.15.0 ‚Üí 9.39.1
- Upgrade @eslint/js to match
- Upgrade prettier 3.4.1 ‚Üí 3.6.2
- Upgrade @typescript-eslint packages to latest 8.x
- Update ESLint config for any new rules
- Run formatting on entire codebase

**Deliverables:**
- Updated ESLint and Prettier packages
- Updated ESLint configuration if needed
- Formatted codebase with new Prettier version
- All lint checks passing

**Test Plan:**
- `pnpm run lint` passes
- `pnpm run format` completes successfully
- `pnpm run format:check` verifies formatting
- Pre-commit hooks work correctly
- CI lint job passes

### M0.5-T5: Upgrade Express to v5 üî¥ TODO
**Objective:** Upgrade Express.js to v5 with breaking changes handled.

**Dependencies:** None

**Current Status:** Express still at 4.21.2 - needs upgrade to 5.1.0

**Spec:**
- Upgrade express 4.21.2 ‚Üí 5.1.0
- Upgrade @types/express to match
- Review middleware for promise rejection handling
- Update route handlers for new error handling
- Review path-to-regexp@8.x changes
- Update Express configuration

**Known Breaking Changes:**
- Middleware can return rejected promises
- path-to-regexp@8.x removes sub-expression regex patterns
- Changes to res.json() behavior
- Updated signature for app.param()

**Deliverables:**
- Updated Express in server/package.json
- Updated server code for Express 5 compatibility
- All server tests passing
- Server starts and responds correctly

**Test Plan:**
- Server starts: `pnpm --filter @cardtable2/server run dev`
- Health check endpoint responds
- WebSocket upgrade works (once y-websocket upgraded)
- All server tests pass
- No deprecation warnings in logs

**Migration Docs:**
- [Express 5.x Migration Guide](https://expressjs.com/en/guide/migrating-5.html)
- [What's New in Express 5.0](https://www.trevorlasn.com/blog/whats-new-in-express-5)

### M0.5-T6: Upgrade Yjs and y-websocket ‚ö†Ô∏è PARTIALLY COMPLETE
**Objective:** Upgrade Yjs ecosystem to latest versions.

**Dependencies:** M0.5-T5 (Express upgrade)

**Current Status:** Yjs upgraded to 13.6.27 ‚úÖ, but y-websocket at 2.1.0 (target 3.0.0)

**Spec:**
- Upgrade yjs 13.6.20 ‚Üí 13.6.27
- Upgrade y-websocket 2.0.4 ‚Üí 3.0.0
- Review y-websocket API changes
- Update server WebSocket setup for v3 API
- Test WebSocket connection and sync

**Known Breaking Changes:**
- y-websocket 3.0 may have API changes (review changelog)
- Possible changes to server setup

**Deliverables:**
- Updated Yjs packages in server/package.json
- Updated WebSocket server code for y-websocket 3.0
- Connection and sync tested
- Server tests passing

**Test Plan:**
- Server starts with y-websocket
- WebSocket connection establishes successfully
- Create test Yjs doc and verify persistence
- No console errors or warnings
- Memory leaks check for long-running connections

**Migration Docs:**
- [y-websocket GitHub](https://github.com/yjs/y-websocket)
- Review CHANGELOG for breaking changes

### M0.5-T7: Final Validation & Documentation üî¥ TODO
**Objective:** Comprehensive testing and documentation of all upgrades.

**Dependencies:** All previous tasks (M0.5-T1 through M0.5-T6)

**Current Status:** Pending completion of React, Express, and y-websocket upgrades

**Spec:**
- Run full validation suite
- Update CLAUDE.md with new versions
- Update package.json with any additional constraint updates
- Document any migration notes for future reference
- Verify CI/CD pipeline end-to-end
- Create git tag for upgraded baseline

**Deliverables:**
- All validation checks pass
- Updated documentation
- Clean CI run on main branch
- Git tag: `v0.0.2-upgraded`

**Test Plan:**
- `pnpm run validate` passes (lint, typecheck, test, build)
- CI passes on all Node versions
- Deploy job runs successfully (placeholder deployment)
- Dev servers start correctly (`pnpm run dev`)
- No console warnings or errors
- All git hooks function correctly

**Validation Checklist:**
```bash
# Root
pnpm run lint          # ESLint checks
pnpm run typecheck     # TypeScript validation
pnpm run test          # All tests
pnpm run build         # Production build
pnpm run format:check  # Formatting verification

# Per-workspace validation
pnpm --filter @cardtable2/app run dev      # App dev server
pnpm --filter @cardtable2/server run dev   # Server dev server
pnpm --filter @cardtable2/app run preview  # Production preview
```

## Risk Mitigation

### High Risk Areas
1. **React 19 Upgrade** - May require code refactoring
   - Mitigation: Review breaking changes, test incrementally

2. **Vite 7 ESM-only** - Build configuration changes
   - Mitigation: Follow migration guide carefully

3. **y-websocket 3.0** - Multiplayer functionality critical
   - Mitigation: Test WebSocket setup thoroughly before proceeding

### Rollback Plan
- Each task should be committed separately
- Tag known-good states
- If critical issues arise, can rollback to v0.0.1
- Document any blockers for future upgrade attempts

## Success Criteria
- ‚úÖ All packages at latest stable versions
- ‚úÖ `pnpm run validate` passes
- ‚úÖ CI/CD pipeline passes on all Node versions
- ‚úÖ No console warnings or errors
- ‚úÖ Dev servers start cleanly
- ‚úÖ Documentation updated
- ‚úÖ Clean git history with tagged baseline

## Estimated Effort
- **M0.5-T1**: 30 minutes
- **M0.5-T2**: 2-3 hours (Vite/Vitest migration)
- **M0.5-T3**: 2-4 hours (React 19 migration)
- **M0.5-T4**: 1 hour (ESLint/Prettier)
- **M0.5-T5**: 2-3 hours (Express 5 migration)
- **M0.5-T6**: 1-2 hours (Yjs ecosystem)
- **M0.5-T7**: 1 hour (validation)

**Total**: 9-14 hours

## Notes
- This milestone is inserted between M0 and M1
- Creates a clean, modern foundation for all future work
- Updates CLAUDE.md to reflect M0.5 as completed once done
- Some tasks can run in parallel (T4 with others)
- React 19 upgrade enables @pixi/react v8 for M2
