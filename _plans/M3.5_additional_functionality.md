# Milestone 3.5 â€” Additional Object Functionality

## Overview
Implement remaining object manipulation actions: card flipping, rotation, stacking, and unstacking. These actions enhance gameplay but are not critical for core multiplayer functionality.

## Prerequisites
- Milestone 5 completed (Multiplayer Server)

## Tasks

### M3.5-T1: Flip Cards âœ…
**Status:** Completed (PR #34)

**Objective:** Implement card flip action to toggle face up/down state.

**Dependencies:** M3 complete, M5 complete

**Spec:**
- Action: `flipCards(store, ids: string[])`
- Toggle `_faceUp` boolean for stack objects and tokens
- Affects objects with `_kind: "stack"` or `_kind: "token"`
- Non-flippable objects ignored
- Transactional update (single Y.Doc transaction)
- Visual update via renderer message

**Deliverables:**
- âœ… `flipCards` action in `YjsActions.ts`
- âœ… Renderer support for face up/down visuals
- âœ… UI trigger (keyboard shortcut 'F', context menu, command palette)
- âœ… Migration system to backfill `_faceUp` property
- âœ… Centralized object defaults system

**Test Plan:**
- âœ… Unit: flip single card stack
- âœ… Unit: flip multiple stacks in batch
- âœ… Unit: verify non-stack objects unaffected
- âœ… Unit: verify transaction atomicity
- âœ… E2E: visual verification of flip animation
- âœ… E2E: flip state persists after refresh
- âœ… E2E: migration tests for old objects without _faceUp

### M3.5-T2: Exhaust/Ready Cards âœ…
**Status:** Completed (PR #36)

**Objective:** Implement exhaust/ready action for card game mechanics.

**Dependencies:** M3.5-T1

**Spec:**
- Action: `exhaustCards(store, ids: string[])`
- Toggle rotation between 0Â° (ready) and 90Â° (exhausted)
- Only applies to objects with `_kind: "stack"`
- Non-stack objects ignored
- Transactional update (single Y.Doc transaction)
- Visual update via renderer with smooth rotation animation

**Deliverables:**
- âœ… `exhaustCards` action in `YjsActions.ts`
- âœ… Smooth rotation animation (200ms with easeOut)
- âœ… UI trigger (keyboard shortcut 'E', action handle)
- âœ… Rotation normalization to [0, 360) range

**Test Plan:**
- âœ… Unit: exhaust single card (0Â° â†’ 90Â°)
- âœ… Unit: ready exhausted card (90Â° â†’ 0Â°)
- âœ… Unit: batch exhaust multiple cards
- âœ… Unit: verify non-stack objects unaffected
- âœ… Unit: verify transaction atomicity
- âœ… E2E: visual verification of rotation animation
- âœ… E2E: rotation state persists after refresh

**Note:** This implements a specific card game mechanic (exhaust/ready) rather than general rotation. A future task could implement general `rotateObjects` with arbitrary angles if needed.

### M3.5-T3: Stack Objects
**Objective:** Implement stacking action to create/merge stacks.

**Dependencies:** M3.5-T2 (Exhaust/Ready)

**Spec:**
- Action: `stackObjects(store, ids: string[], targetId?: string)`
- Merge multiple stacks into one
- Combine `_cards` arrays in order
- Delete source stacks, keep/create target
- Use fractional indexing for z-order
- Preserve face-up state of target (or top card)

**Deliverables:**
- `stackObjects` action in `YjsActions.ts`
- Visual feedback for stack merging
- UI trigger (drag-and-drop stacks together)

**Test Plan:**
- Unit: merge two stacks
- Unit: merge multiple stacks (3+)
- Unit: verify card order preservation
- Unit: verify source stack deletion
- E2E: drag stack onto stack to merge
- E2E: merged stack persists after refresh

### M3.5-T4: Unstack
**Objective:** Implement unstacking action to separate cards.

**Dependencies:** M3.5-T3

**Spec:**
- Action: `unstackCard(store, stackId, cardIndex, pos)`
- Extract single card from stack
- Create new stack with one card
- Remove card from source stack
- Position new stack at specified location
- Support "draw from top/bottom" modes

**Deliverables:**
- `unstackCard` action in `YjsActions.ts`
- Visual feedback for card separation
- UI triggers (click to draw, drag to split)

**Test Plan:**
- Unit: extract card from multi-card stack
- Unit: extract last card (stack becomes empty, deleted)
- Unit: verify source stack updates correctly
- Unit: verify new stack created with correct properties
- E2E: drag card out of stack visually
- E2E: unstacked cards persist after refresh

## Integration Notes

### Multiplayer Considerations
All actions must work correctly in multiplayer scenarios:
- Concurrent flips by different actors
- Concurrent exhaust/ready actions (last write wins)
- Stack merging race conditions
- Unstack operations on same stack

### Renderer Updates
Each action requires corresponding renderer message handling:
- `flip-cards`: Update sprite textures with flip animation
- `exhaust-cards`: Update container rotation with smooth animation
- `stack-objects`: Merge visuals, delete old containers
- `unstack-card`: Create new visual, update stack count

### Testing Strategy
- Unit tests for all action functions (atomicity, edge cases)
- E2E tests for visual feedback and persistence
- Multiplayer conflict tests (two-tab scenarios)
- Performance tests (batch operations on 100+ objects)

## Status
ğŸš§ In Progress
- âœ… M3.5-T1: Flip Cards (Completed - PR #34)
- âœ… M3.5-T2: Exhaust/Ready Cards (Completed - PR #36)
- â¸ï¸ M3.5-T3: Stack Objects (Next up)
- â¸ï¸ M3.5-T4: Unstack

## Notes
- These actions enhance gameplay but are not blockers for core multiplayer
- Can be implemented incrementally after M5 is stable
- Some actions (like flip/rotate) may benefit from keyboard shortcuts
- Stack/unstack UI may require gesture detection improvements
