# Milestone 3.5 — Additional Object Functionality

## Overview
Implement remaining object manipulation actions: card flipping, rotation, stacking, and unstacking. These actions enhance gameplay but are not critical for core multiplayer functionality.

## Prerequisites
- Milestone 5 completed (Multiplayer Server)

## Tasks

### M3.5-T1: Flip Cards
**Objective:** Implement card flip action to toggle face up/down state.

**Dependencies:** M3 complete, M5 complete

**Spec:**
- Action: `flipCards(store, ids: string[])`
- Toggle `_faceUp` boolean for stack objects
- Only affects objects with `_kind: "stack"`
- Non-stack objects ignored
- Transactional update (single Y.Doc transaction)
- Visual update via renderer message

**Deliverables:**
- `flipCards` action in `YjsActions.ts`
- Renderer support for face up/down visuals
- UI trigger (button or keyboard shortcut)

**Test Plan:**
- Unit: flip single card stack
- Unit: flip multiple stacks in batch
- Unit: verify non-stack objects unaffected
- Unit: verify transaction atomicity
- E2E: visual verification of flip animation
- E2E: flip state persists after refresh

### M3.5-T2: Rotate Objects
**Objective:** Implement rotation action for all object types.

**Dependencies:** M3.5-T1

**Spec:**
- Action: `rotateObjects(store, updates: Array<{id, rotation}>)`
- Update `_pos.r` field (degrees)
- Apply to all object types
- Support both absolute and relative rotation
- Optional: snap to 90° increments

**Deliverables:**
- `rotateObjects` action in `YjsActions.ts`
- UI controls for rotation (e.g., R key, mouse wheel)
- Visual rotation feedback in renderer

**Test Plan:**
- Unit: rotate single object
- Unit: batch rotation of multiple objects
- Unit: verify all object types support rotation
- E2E: rotation persists after refresh
- E2E: rotation visual feedback

### M3.5-T3: Stack Objects
**Objective:** Implement stacking action to create/merge stacks.

**Dependencies:** M3.5-T2

**Spec:**
- Action: `stackObjects(store, ids: string[], targetId?: string)`
- Merge multiple stacks into one
- Combine `_cards` arrays in order
- Delete source stacks, keep/create target
- Use fractional indexing for z-order
- Preserve face-up state of target (or top card)

**Deliverables:**
- `stackObjects` action in `YjsActions.ts`
- Visual feedback for stack merging
- UI trigger (drag-and-drop stacks together)

**Test Plan:**
- Unit: merge two stacks
- Unit: merge multiple stacks (3+)
- Unit: verify card order preservation
- Unit: verify source stack deletion
- E2E: drag stack onto stack to merge
- E2E: merged stack persists after refresh

### M3.5-T4: Unstack
**Objective:** Implement unstacking action to separate cards.

**Dependencies:** M3.5-T3

**Spec:**
- Action: `unstackCard(store, stackId, cardIndex, pos)`
- Extract single card from stack
- Create new stack with one card
- Remove card from source stack
- Position new stack at specified location
- Support "draw from top/bottom" modes

**Deliverables:**
- `unstackCard` action in `YjsActions.ts`
- Visual feedback for card separation
- UI triggers (click to draw, drag to split)

**Test Plan:**
- Unit: extract card from multi-card stack
- Unit: extract last card (stack becomes empty, deleted)
- Unit: verify source stack updates correctly
- Unit: verify new stack created with correct properties
- E2E: drag card out of stack visually
- E2E: unstacked cards persist after refresh

## Integration Notes

### Multiplayer Considerations
All actions must work correctly in multiplayer scenarios:
- Concurrent flips by different actors
- Rotation conflicts (last write wins)
- Stack merging race conditions
- Unstack operations on same stack

### Renderer Updates
Each action requires corresponding renderer message handling:
- `flip-cards`: Update sprite textures
- `rotate-objects`: Update container rotation
- `stack-objects`: Merge visuals, delete old containers
- `unstack-card`: Create new visual, update stack count

### Testing Strategy
- Unit tests for all action functions (atomicity, edge cases)
- E2E tests for visual feedback and persistence
- Multiplayer conflict tests (two-tab scenarios)
- Performance tests (batch operations on 100+ objects)

## Status
⏸️ Not started — Prerequisites: M5 complete

## Notes
- These actions enhance gameplay but are not blockers for core multiplayer
- Can be implemented incrementally after M5 is stable
- Some actions (like flip/rotate) may benefit from keyboard shortcuts
- Stack/unstack UI may require gesture detection improvements
